# è¯å“é”€å”®ç®¡ç†ç³»ç»Ÿ - ERå›¾ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€å½“å‰ERå›¾å­˜åœ¨çš„é—®é¢˜

### 1.1 å…³ç³»å†—ä½™
- **é—®é¢˜**ï¼š`sales_detail` åŒæ—¶é€šè¿‡ `sales_med` å’Œ `consume` å…³è” `medicine` å’Œ `stock_batch`
- **åˆ†æ**ï¼šç”±äº `stock_batch` å·²ç»é€šè¿‡ `stock_med` å…³è”åˆ° `medicine`ï¼Œå› æ­¤ `sales_med` æ˜¯å†—ä½™çš„
- **ä¼˜åŒ–**ï¼šåˆ é™¤ `sales_med` å…³ç³»ï¼Œä¿ç•™ `consume` å³å¯é€šè¿‡æ‰¹æ¬¡è¿½æº¯åˆ°è¯å“

### 1.2 ç¼ºå°‘ç›´æ¥å…³è”
- **é—®é¢˜**ï¼š`t_sales_detail` è¡¨ä¸­ç¼ºå°‘ `med_id` å­—æ®µ
- **å½±å“**ï¼šæŸ¥è¯¢é”€å”®æ˜ç»†æ—¶éœ€è¦é€šè¿‡ `batch_id -> stock_batch -> med_id` å¤šè¡¨è¿æ¥
- **ä¼˜åŒ–**ï¼šåœ¨ `t_sales_detail` æ·»åŠ  `med_id` å­—æ®µï¼ˆå·²åœ¨æ–° init.sql ä¸­å®ç°ï¼‰

### 1.3 é€€è´§å…³ç³»ä¸æ˜ç¡®
- **é—®é¢˜**ï¼š`purchase_return` å’Œ `sales_return` é€šè¿‡ `batch_id` (VARCHAR) å…³è”æ‰¹æ¬¡
- **åˆ†æ**ï¼šbatch_id åº”ä¸º INT ç±»å‹çš„æ‰¹æ¬¡IDï¼Œè€Œé VARCHAR çš„æ‰¹å·
- **ä¼˜åŒ–**ï¼šé€€è´§è¡¨åº”å…³è” `stock_batch.batch_id` (INT)ï¼Œè€Œé `batch_no` (VARCHAR)

### 1.4 ç›˜ç‚¹å…³ç³»é€»è¾‘
- **é—®é¢˜**ï¼š`inventory_check` åŒæ—¶å…³è” `stock_batch` å’Œ `employee`
- **åˆ†æ**ï¼š`check` å…³ç³»è¡¨ç¤º"è°ç›˜ç‚¹äº†å“ªä¸ªæ‰¹æ¬¡"ï¼Œè¿™æ˜¯åˆç†çš„ä¸‰å…ƒå…³ç³»
- **ä¼˜åŒ–**ï¼šä¿æŒç°çŠ¶ï¼Œä½†éœ€ç¡®ä¿è§¦å‘å™¨æ­£ç¡®æ›´æ–°åº“å­˜

## äºŒã€ä¼˜åŒ–åçš„ERå›¾è®¾è®¡

### 2.1 æ ¸å¿ƒå®ä½“ï¼ˆå¼ºå®ä½“é›†ï¼‰

#### å‘˜å·¥å®ä½“ (employee)
```
å±æ€§: emp_id(PK), emp_name, pwd, role, phone, status, created_at
è§’è‰²: 'Admin', 'Sales', 'Stock'ï¼ˆå·²ç§»é™¤Financeï¼‰
```

#### ä¾›åº”å•†å®ä½“ (supplier)
```
å±æ€§: sup_id(PK), sup_name, contact_name, phone, address, license_no, status, created_at
```

#### å®¢æˆ·å®ä½“ (customer)
```
å±æ€§: cus_id(PK), cus_name, gender, phone, age, medical_history, total_consume, created_at
```

#### è¯å“å®ä½“ (medicine)
```
å±æ€§: med_id(PK), med_name, spec, category, unit, factory, 
     ref_buy_price, ref_sell_price, total_stock, alert_qty, created_at, updated_at
æ´¾ç”Ÿå±æ€§: is_low_stock (total_stock < alert_qty)
```

#### é‡‡è´­è®¢å•å®ä½“ (purchase_order)
```
å±æ€§: po_id(PK), total_amount, purchase_date, status
```

#### é”€å”®è®¢å•å®ä½“ (sales_order)
```
å±æ€§: so_id(PK), sale_time, total_price, status
```

#### åº“å­˜æ‰¹æ¬¡å®ä½“ (stock_batch)
```
å±æ€§: batch_id(PK), batch_no, expiry_date, cur_batch__qty, create_time
æ´¾ç”Ÿå±æ€§: is_expired, days_to_expire
```

#### ç›˜ç‚¹è®°å½•å®ä½“ (inventory_check)
```
å±æ€§: check_id(PK), book_qty, actual_qty, check_time, remark
è®¡ç®—å±æ€§: diff_qty = actual_qty - book_qty
```

#### é‡‡è´­é€€è´§å®ä½“ (purchase_return)
```
å±æ€§: pr_id(PK), quantity, return_time, reason, status
```

#### é”€å”®é€€è´§å®ä½“ (sales_return)
```
å±æ€§: sr_id(PK), quantity, return_time, reason, status
```

#### è´¢åŠ¡æ—¥ç»“å®ä½“ (finance_daily)
```
å±æ€§: day_id(PK), sales_revenue, sales_profit, sales_return_amt, 
     purc_return_amt, inv_loss_amt, inv_gain_amt
è®¡ç®—å±æ€§: net_profit = sales_profit - sales_return_amt + purc_return_amt - inv_loss_amt + inv_gain_amt
```

### 2.2 å¼±å®ä½“é›†

#### é‡‡è´­æ˜ç»† (purchase_detail)
```
æ ‡è¯†æ€§ä¾èµ–: purchase_order
åˆ†è¾¨ç¬¦: pd_id
å±æ€§: batch_no, produce_date, expiry_date, quantity, unit_purc_price
```

#### é”€å”®æ˜ç»† (sales_detail)
```
æ ‡è¯†æ€§ä¾èµ–: sales_order
åˆ†è¾¨ç¬¦: sd_id
å±æ€§: quantity, unit_sell_price
æ–°å¢å†—ä½™: med_idï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
```

### 2.3 ä¼˜åŒ–åçš„å…³ç³»é›†

#### 1. purchase (é‡‡è´­) - ä¸‰å…ƒå…³ç³»
```
å‚ä¸å®ä½“: supplier (N) - employee (N) - purchase_order (1)
åŸºæ•°: N:1:1
è¯­ä¹‰: ä¾›åº”å•† + ç»æ‰‹äºº â†’ é‡‡è´­è®¢å•
å¤–é”®: purchase_order.sup_id, purchase_order.emp_id
```

#### 2. sale (é”€å”®) - ä¸‰å…ƒå…³ç³»
```
å‚ä¸å®ä½“: customer (N) - employee (N) - sales_order (1)
åŸºæ•°: N:1:1
è¯­ä¹‰: å®¢æˆ· + é”€å”®å‘˜ â†’ é”€å”®è®¢å•
å¤–é”®: sales_order.cus_id, sales_order.emp_id
```

#### 3. contain_purc (åŒ…å«é‡‡è´­æ˜ç»†) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: purchase_order (1) - purchase_detail (N)
åŸºæ•°: 1:N
è¯­ä¹‰: ä¸€ä¸ªé‡‡è´­è®¢å•åŒ…å«å¤šä¸ªæ˜ç»†è¡Œ
å¤–é”®: purchase_detail.po_id
```

#### 4. contains_sales (åŒ…å«é”€å”®æ˜ç»†) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: sales_order (1) - sales_detail (N)
åŸºæ•°: 1:N
è¯­ä¹‰: ä¸€ä¸ªé”€å”®è®¢å•åŒ…å«å¤šä¸ªæ˜ç»†è¡Œ
å¤–é”®: sales_detail.so_id
```

#### 5. purc_med (é‡‡è´­è¯å“) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: purchase_detail (N) - medicine (1)
åŸºæ•°: N:1
è¯­ä¹‰: é‡‡è´­æ˜ç»†æŒ‡å‘å…·ä½“è¯å“
å¤–é”®: purchase_detail.med_id
```

#### 6. stock_med (åº“å­˜è¯å“) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: stock_batch (N) - medicine (1)
åŸºæ•°: N:1
è¯­ä¹‰: æ¯ä¸ªæ‰¹æ¬¡å±äºä¸€ç§è¯å“
å¤–é”®: stock_batch.med_id
çº¦æŸ: UNIQUE(med_id, batch_no)
```

#### 7. **consume (æ¶ˆè€—æ‰¹æ¬¡) - äºŒå…ƒå…³ç³»** âœ… å…³é”®ä¼˜åŒ–
```
å‚ä¸å®ä½“: sales_detail (N) - stock_batch (1)
åŸºæ•°: N:1
è¯­ä¹‰: é”€å”®æ˜ç»†æ¶ˆè€—ç‰¹å®šæ‰¹æ¬¡
å¤–é”®: sales_detail.batch_id
è§¦å‘å™¨: è‡ªåŠ¨æ‰£å‡ stock_batch.cur_batch__qty
```

#### 8. **sales_med_direct (é”€å”®è¯å“å†—ä½™) - äºŒå…ƒå…³ç³»** âœ… æ–°å¢
```
å‚ä¸å®ä½“: sales_detail (N) - medicine (1)
åŸºæ•°: N:1
è¯­ä¹‰: é”€å”®æ˜ç»†ç›´æ¥å…³è”è¯å“ï¼ˆå†—ä½™è®¾è®¡ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
å¤–é”®: sales_detail.med_id
è¯´æ˜: è™½ç„¶å¯é€šè¿‡ batch_id â†’ med_id é—´æ¥è·å–ï¼Œä½†ç›´æ¥å­˜å‚¨é¿å…å¤šè¡¨JOIN
```

#### 9. check (ç›˜ç‚¹) - ä¸‰å…ƒå…³ç³»
```
å‚ä¸å®ä½“: stock_batch (N) - employee (N) - inventory_check (1)
åŸºæ•°: N:N:1
è¯­ä¹‰: å‘˜å·¥å¯¹æ‰¹æ¬¡è¿›è¡Œç›˜ç‚¹
å¤–é”®: inventory_check.batch_id, inventory_check.emp_id
```

#### 10. pur_return (é‡‡è´­é€€è´§) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: purchase_order (1) - purchase_return (N)
åŸºæ•°: 1:N
è¯­ä¹‰: é’ˆå¯¹é‡‡è´­è®¢å•äº§ç”Ÿé€€è´§
å¤–é”®: purchase_return.po_id
```

#### 11. sales_return_rel (é”€å”®é€€è´§) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: sales_order (1) - sales_return (N)
åŸºæ•°: 1:N
è¯­ä¹‰: é’ˆå¯¹é”€å”®è®¢å•äº§ç”Ÿé€€è´§
å¤–é”®: sales_return.so_id
```

#### 12. return_to (é€€è´§è‡³ä¾›åº”å•†) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: purchase_return (N) - supplier (1)
åŸºæ•°: N:1
è¯­ä¹‰: é€€è´§å•é€€è¿˜ç»™ä¾›åº”å•†
å¤–é”®: purchase_return.sup_id
```

#### 13. handle (å¤„ç†é€€è´§) - äºŒå…ƒå…³ç³»
```
å‚ä¸å®ä½“: employee (N) - sales_return (N)
åŸºæ•°: N:N
è¯­ä¹‰: å‘˜å·¥å¤„ç†é”€å”®é€€è´§
å¤–é”®: sales_return.emp_id
```

#### 14. **pr_stock (é‡‡è´­é€€è´§æ‰¹æ¬¡) - äºŒå…ƒå…³ç³»** âœ… ä¿®æ­£
```
å‚ä¸å®ä½“: purchase_return (N) - stock_batch (1)
åŸºæ•°: N:1
è¯­ä¹‰: é€€è´§å•å…³è”å…·ä½“æ‰¹æ¬¡
å¤–é”®: purchase_return.batch_id â†’ stock_batch.batch_id (INT)
ä¿®æ­£: åŸè®¾è®¡ä½¿ç”¨ batch_no (VARCHAR)ï¼Œåº”æ”¹ä¸º batch_id (INT)
```

#### 15. **sr_stock (é”€å”®é€€è´§æ‰¹æ¬¡) - äºŒå…ƒå…³ç³»** âœ… ä¿®æ­£
```
å‚ä¸å®ä½“: sales_return (N) - stock_batch (1)
åŸºæ•°: N:1
è¯­ä¹‰: é€€è´§å•å…³è”å…·ä½“æ‰¹æ¬¡
å¤–é”®: sales_return.batch_id â†’ stock_batch.batch_id (INT)
ä¿®æ­£: åŸè®¾è®¡ä½¿ç”¨ batch_no (VARCHAR)ï¼Œåº”æ”¹ä¸º batch_id (INT)
```

## ä¸‰ã€ERå›¾å¸ƒå±€ä¼˜åŒ–å»ºè®®

### 3.1 åˆ†å±‚å¸ƒå±€ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€ä¿¡æ¯å±‚ï¼ˆé¡¶å±‚ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ å‘˜å·¥ â”‚  â”‚ä¾›åº”å•†â”‚  â”‚ å®¢æˆ· â”‚  â”‚ è¯å“ â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ purchase        â†“ sale        â†“ stock_med
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å•æ®ä¸»è¡¨å±‚ï¼ˆä¸­å±‚ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚é‡‡è´­è®¢å•   â”‚                      â”‚é”€å”®è®¢å•   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚åº“å­˜æ‰¹æ¬¡   â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ contain_purc  â†“ store     â†“ consume  â†“ contains_sales
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ˜ç»†å¼±å®ä½“å±‚ï¼ˆåº•å±‚ï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚é‡‡è´­æ˜ç»†   â”‚                      â”‚é”€å”®æ˜ç»†   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ pur_return            â†“ sales_return
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é€€è´§å¤„ç†å±‚ï¼ˆæ‰©å±•ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚é‡‡è´­é€€è´§   â”‚  â”‚é”€å”®é€€è´§   â”‚  â”‚ç›˜ç‚¹è®°å½•   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ èšåˆç»Ÿè®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è´¢åŠ¡ç»Ÿè®¡å±‚ï¼ˆç‹¬ç«‹ï¼‰                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚è´¢åŠ¡æ—¥ç»“   â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é…è‰²æ–¹æ¡ˆ

- **è“è‰²**ï¼šåŸºç¡€ä¿¡æ¯ç±»å®ä½“ï¼ˆå‘˜å·¥ã€ä¾›åº”å•†ã€å®¢æˆ·ã€è¯å“ï¼‰
- **ç»¿è‰²**ï¼šå•æ®ä¸»è¡¨ç±»å®ä½“ï¼ˆé‡‡è´­è®¢å•ã€é”€å”®è®¢å•ï¼‰
- **æ©™è‰²**ï¼šåº“å­˜ç›¸å…³å®ä½“ï¼ˆåº“å­˜æ‰¹æ¬¡ã€ç›˜ç‚¹è®°å½•ï¼‰
- **é»„è‰²**ï¼šå¼±å®ä½“é›†ï¼ˆé‡‡è´­æ˜ç»†ã€é”€å”®æ˜ç»†ï¼‰
- **çº¢è‰²**ï¼šé€€è´§ç±»å®ä½“ï¼ˆé‡‡è´­é€€è´§ã€é”€å”®é€€è´§ï¼‰
- **ç´«è‰²**ï¼šè´¢åŠ¡ç»Ÿè®¡å®ä½“ï¼ˆè´¢åŠ¡æ—¥ç»“ï¼‰

### 3.3 å…³ç³»çº¿æ¡è§„èŒƒ

- **ç²—å®çº¿**ï¼šå¼ºä¾èµ–å…³ç³»ï¼ˆå¦‚è®¢å•åˆ°æ˜ç»†ï¼‰
- **ç»†å®çº¿**ï¼šå¼±ä¾èµ–å…³ç³»ï¼ˆå¦‚å‘˜å·¥åˆ°è®¢å•ï¼‰
- **è™šçº¿**ï¼šè®¡ç®—/æ´¾ç”Ÿå…³ç³»ï¼ˆå¦‚è´¢åŠ¡ç»Ÿè®¡ï¼‰
- **ç®­å¤´æ–¹å‘**ï¼šæŒ‡å‘"å¤š"ç«¯ï¼ˆNç«¯ï¼‰

## å››ã€ä¸å½“å‰æ•°æ®åº“çš„å¯¹åº”å…³ç³»

### 4.1 å·²å®ç°çš„ä¼˜åŒ– âœ…

| ä¼˜åŒ–é¡¹ | ERå›¾è®¾è®¡ | æ•°æ®åº“å®ç° | çŠ¶æ€ |
|--------|----------|-----------|------|
| é”€å”®æ˜ç»†å¢åŠ med_id | sales_detail.med_id | t_sales_detail.med_id | âœ… å·²å®ç° |
| åº“å­˜æ‰¹æ¬¡å­—æ®µå | cur_batch__qty | t_stock_batch.cur_batch__qty | âœ… å·²å®ç° |
| æ‰¹æ¬¡åˆ›å»ºæ—¶é—´ç±»å‹ | create_time (DATE) | t_stock_batch.create_time DATE | âœ… å·²å®ç° |
| ç§»é™¤Financeè§’è‰² | employee.role | ENUM('Admin','Sales','Stock') | âœ… å·²å®ç° |

### 4.2 å¾…ä¿®æ­£çš„é—®é¢˜ âš ï¸

| é—®é¢˜ | å½“å‰çŠ¶æ€ | å»ºè®®ä¿®æ”¹ | ä¼˜å…ˆçº§ |
|------|---------|----------|--------|
| é€€è´§è¡¨batch_idç±»å‹ | VARCHAR(30) | INT (å…³è”batch_id) | é«˜ |
| åˆ é™¤å†—ä½™çš„sales_med | ERå›¾ä¸­å­˜åœ¨ | ä»…ä¿ç•™consumeå…³ç³» | ä¸­ |
| ç›˜ç‚¹ååº“å­˜æ›´æ–° | è§¦å‘å™¨å·²å®ç° | éœ€æµ‹è¯•éªŒè¯ | é«˜ |

## äº”ã€ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§éªŒè¯

### 5.1 è¿›è´§æµç¨‹
```
1. åˆ›å»ºé‡‡è´­è®¢å• (purchase_order) â†’ purchase å…³ç³»
2. æ·»åŠ é‡‡è´­æ˜ç»† (purchase_detail) â†’ contain_purc å…³ç³»
3. è§¦å‘å™¨è‡ªåŠ¨åˆ›å»º/æ›´æ–°åº“å­˜æ‰¹æ¬¡ (stock_batch) â†’ store å…³ç³»
4. æ›´æ–°è¯å“æ€»åº“å­˜ (medicine.total_stock)
```

### 5.2 é”€å”®æµç¨‹
```
1. åˆ›å»ºé”€å”®è®¢å• (sales_order) â†’ sale å…³ç³»
2. æ·»åŠ é”€å”®æ˜ç»† (sales_detail) â†’ contains_sales å…³ç³»
3. æŒ‡å®šæ‰¹æ¬¡å‡ºåº“ (batch_id) â†’ consume å…³ç³»
4. è§¦å‘å™¨æ‰£å‡æ‰¹æ¬¡åº“å­˜ (cur_batch__qty)
5. è§¦å‘å™¨æ‰£å‡æ€»åº“å­˜ (total_stock)
6. æ›´æ–°å®¢æˆ·æ¶ˆè´¹æ€»é¢ (total_consume)
```

### 5.3 é€€è´§æµç¨‹
```
é‡‡è´­é€€è´§:
1. åˆ›å»ºé€€è´§å• (purchase_return) â†’ pur_return å…³ç³»
2. å…³è”åŸé‡‡è´­è®¢å• (po_id)
3. å…³è”é€€è´§æ‰¹æ¬¡ (batch_id) â†’ pr_stock å…³ç³»
4. è§¦å‘å™¨æ‰£å‡åº“å­˜

é”€å”®é€€è´§:
1. åˆ›å»ºé€€è´§å• (sales_return) â†’ sales_return_rel å…³ç³»
2. å…³è”åŸé”€å”®è®¢å• (so_id)
3. å…³è”é€€è´§æ‰¹æ¬¡ (batch_id) â†’ sr_stock å…³ç³»
4. è§¦å‘å™¨æ¢å¤åº“å­˜
```

### 5.4 ç›˜ç‚¹æµç¨‹
```
1. å‘˜å·¥å‘èµ·ç›˜ç‚¹ (inventory_check) â†’ check å…³ç³»
2. è®°å½•è´¦é¢æ•°é‡ (book_qty) å’Œå®ç‰©æ•°é‡ (actual_qty)
3. è®¡ç®—å·®å¼‚ (diff_qty)
4. è§¦å‘å™¨è°ƒæ•´åº“å­˜ (cur_batch__qty)
5. æ›´æ–°è´¢åŠ¡æ—¥ç»“ (inv_loss_amt / inv_gain_amt)
```

## å…­ã€æ¨èçš„ERå›¾ç»˜åˆ¶å·¥å…·

1. **Draw.io (æ¨è)**ï¼šå…è´¹åœ¨çº¿å·¥å…·ï¼Œæ”¯æŒERå›¾æ¨¡æ¿
2. **dbdiagram.io**ï¼šä¸“é—¨çš„æ•°æ®åº“ERå›¾å·¥å…·ï¼Œå¯å¯¼å‡ºSQL
3. **MySQL Workbench**ï¼šè‡ªå¸¦ERå›¾é€†å‘å·¥ç¨‹åŠŸèƒ½
4. **Lucidchart**ï¼šä¸“ä¸šçš„å›¾è¡¨ç»˜åˆ¶å·¥å…·
5. **PlantUML**ï¼šä»£ç ç”ŸæˆERå›¾ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶

## ä¸ƒã€æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›ç‚¹ï¼š
1. âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨ `sales_detail` æ·»åŠ  `med_id` å†—ä½™å­—æ®µ
2. âš ï¸ **å…³ç³»ä¿®æ­£**ï¼šé€€è´§è¡¨çš„ `batch_id` åº”ä¸º INT ç±»å‹
3. âœ… **å­—æ®µè§„èŒƒ**ï¼š`cur_batch__qty`ï¼ˆåŒä¸‹åˆ’çº¿ï¼‰ã€`create_time`ï¼ˆDATEï¼‰
4. âœ… **è§’è‰²ç®€åŒ–**ï¼šç§»é™¤ Finance è§’è‰²
5. ğŸ“‹ **å¸ƒå±€ä¼˜åŒ–**ï¼šåˆ†å±‚å¸ƒå±€ç­–ç•¥ï¼Œæå‡ERå›¾å¯è¯»æ€§

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š
- [ ] ä¿®æ”¹é€€è´§è¡¨çš„ batch_id ç±»å‹ï¼ˆéœ€æ›´æ–° models.py å’Œ init.sqlï¼‰
- [ ] æ›´æ–° ER.drawio æ–‡ä»¶ï¼Œåº”ç”¨ä¼˜åŒ–åçš„å¸ƒå±€
- [ ] åˆ é™¤ ER å›¾ä¸­çš„å†—ä½™ sales_med å…³ç³»
- [ ] æµ‹è¯•æ‰€æœ‰è§¦å‘å™¨çš„ä¸šåŠ¡é€»è¾‘
- [ ] éªŒè¯è§†å›¾æŸ¥è¯¢æ€§èƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æœ€åæ›´æ–°**ï¼š2026-01-03  
**ç»´æŠ¤äºº**ï¼šæ•°æ®åº“è®¾è®¡å¸ˆ
