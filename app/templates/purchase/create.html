{% extends 'base.html' %}

{% block page_title %}新建进货单{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-plus"></i> 新建进货单
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label">供应商 <span class="text-danger">*</span></label>
                <select class="form-select" id="sup_id" required>
                    <option value="">请选择供应商</option>
                    {% for s in suppliers %}
                    <option value="{{ s.sup_id }}">{{ s.sup_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <h6><i class="fas fa-list"></i> 进货明细</h6>
        <div class="table-responsive mb-3">
            <table class="table" id="detailTable">
                <thead>
                    <tr>
                        <th width="25%">药品</th>
                        <th width="15%">批号</th>
                        <th width="12%">生产日期</th>
                        <th width="12%">有效期至</th>
                        <th width="10%">数量</th>
                        <th width="12%">单价</th>
                        <th width="10%">小计</th>
                        <th width="4%"></th>
                    </tr>
                </thead>
                <tbody id="detailBody">
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6" class="text-end fw-bold">合计:</td>
                        <td class="fw-bold text-primary" id="totalAmount">¥0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <button type="button" class="btn btn-outline-success mb-4" onclick="addRow()">
            <i class="fas fa-plus"></i> 添加药品
        </button>
        
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" onclick="submitOrder()">
                <i class="fas fa-save"></i> 提交入库
            </button>
            <a href="{{ url_for('purchase.list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const medicines = {{ medicines|tojson if medicines else '[]'|safe }};
let rowIndex = 0;

function addRow() {
    const tbody = document.getElementById('detailBody');
    const row = document.createElement('tr');
    row.id = 'row_' + rowIndex;
    
    let options = '<option value="">选择药品</option>';
    medicines.forEach(m => {
        options += `<option value="${m.med_id}" data-price="${m.ref_buy_price}">${m.med_name} (${m.spec})</option>`;
    });
    
    row.innerHTML = `
        <td>
            <select class="form-select form-select-sm" name="med_id" onchange="onMedicineChange(this, ${rowIndex})">
                ${options}
            </select>
        </td>
        <td><input type="text" class="form-control form-control-sm" name="batch_no" placeholder="批号" required></td>
        <td><input type="date" class="form-control form-control-sm" name="produce_date"></td>
        <td><input type="date" class="form-control form-control-sm" name="expiry_date" required></td>
        <td><input type="number" class="form-control form-control-sm" name="quantity" min="1" value="1" onchange="calcRow(${rowIndex})"></td>
        <td><input type="number" class="form-control form-control-sm" name="unit_price" step="0.01" min="0" value="0" onchange="calcRow(${rowIndex})"></td>
        <td class="subtotal">¥0.00</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(${rowIndex})"><i class="fas fa-times"></i></button></td>
    `;
    
    tbody.appendChild(row);
    rowIndex++;
}

function onMedicineChange(select, idx) {
    const price = select.options[select.selectedIndex].dataset.price || 0;
    const row = document.getElementById('row_' + idx);
    row.querySelector('[name="unit_price"]').value = price;
    calcRow(idx);
}

function calcRow(idx) {
    const row = document.getElementById('row_' + idx);
    if (!row) return;
    
    const qty = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
    const price = parseFloat(row.querySelector('[name="unit_price"]').value) || 0;
    const subtotal = qty * price;
    
    row.querySelector('.subtotal').textContent = '¥' + subtotal.toFixed(2);
    calcTotal();
}

function calcTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal').forEach(td => {
        total += parseFloat(td.textContent.replace('¥', '')) || 0;
    });
    document.getElementById('totalAmount').textContent = '¥' + total.toFixed(2);
}

function removeRow(idx) {
    const row = document.getElementById('row_' + idx);
    if (row) {
        row.remove();
        calcTotal();
    }
}

function submitOrder() {
    const supId = document.getElementById('sup_id').value;
    if (!supId) {
        alert('请选择供应商');
        return;
    }
    
    const items = [];
    document.querySelectorAll('#detailBody tr').forEach(row => {
        const medId = row.querySelector('[name="med_id"]').value;
        const batchNo = row.querySelector('[name="batch_no"]').value;
        const expiryDate = row.querySelector('[name="expiry_date"]').value;
        const quantity = row.querySelector('[name="quantity"]').value;
        const unitPrice = row.querySelector('[name="unit_price"]').value;
        const produceDate = row.querySelector('[name="produce_date"]').value;
        
        if (medId && batchNo && expiryDate && quantity) {
            items.push({
                med_id: medId,
                batch_no: batchNo,
                produce_date: produceDate,
                expiry_date: expiryDate,
                quantity: parseInt(quantity),
                unit_price: parseFloat(unitPrice)
            });
        }
    });
    
    if (items.length === 0) {
        alert('请添加至少一个药品');
        return;
    }
    
    fetch('{{ url_for("purchase.create") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sup_id: supId, items: items})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '{{ url_for("purchase.list") }}';
        } else {
            alert(data.message);
        }
    })
    .catch(err => alert('请求失败: ' + err));
}

// 初始添加一行
addRow();
</script>
{% endblock %}
