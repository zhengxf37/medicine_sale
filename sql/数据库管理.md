# 药品销售管理系统 - 数据库管理文档

## 一、数据库管理员（DBA）角色职责

### 1. 核心工作内容

#### 1.1 数据库设计与规划
- **物理模型设计**：基于ER图设计具体的表结构、字段类型、约束条件
- **性能优化设计**：创建合理的索引策略，优化查询性能
- **存储规划**：规划数据库存储空间、日志空间、备份空间
- **命名规范制定**：统一表名（t_前缀）、字段名、索引名等命名标准

#### 1.2 数据库创建与初始化
```sql
-- 创建数据库
CREATE DATABASE pharmacy_db 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 设置外键约束检查
SET FOREIGN_KEY_CHECKS = 0;  -- 创建表时临时关闭
SET FOREIGN_KEY_CHECKS = 1;  -- 完成后开启
```

- 执行DDL脚本创建表结构
- 设计合理的外键关系，确保数据完整性
- 创建必要的索引提升查询效率
- 插入初始测试数据

#### 1.3 触发器与存储过程开发

**关键触发器设计**：
- `trg_after_purchase_detail_insert`：采购后自动更新库存
- `trg_after_sales_detail_insert`：销售后自动扣减库存
- `trg_after_sales_return_insert`：销售退货恢复库存
- `trg_after_purchase_return_insert`：购进退货扣减库存
- `trg_after_inventory_check_insert`：盘点后调整库存

**存储函数**：
- `fn_generate_po_id()`：生成进货单号（P20260103+流水号）
- `fn_generate_so_id()`：生成销售单号（S20260103+流水号）

**存储过程**：
- `sp_monthly_report(year, month)`：月度财务统计报表

#### 1.4 视图设计

创建业务视图简化应用层查询：
- `v_expired_drugs`：过期药品视图（含即将过期、临期提醒）
- `v_low_stock`：缺货预警视图（低于预警线）
- `v_stock_detail`：库存明细视图（批次级别）
- `v_sales_statistics`：销售统计视图（按日汇总）
- `v_top_selling`：畅销药品排行（TOP 10）

#### 1.5 性能优化

**索引策略**：
```sql
CREATE INDEX idx_medicine_name ON t_medicine(med_name);
CREATE INDEX idx_stock_expiry ON t_stock_batch(expiry_date);
CREATE INDEX idx_purchase_date ON t_purchase_order(purchase_date);
CREATE INDEX idx_sales_time ON t_sales_order(sale_time);
```

**查询优化**：
- 分析慢查询日志
- 使用 EXPLAIN 分析执行计划
- 避免全表扫描，合理使用索引
- 优化JOIN查询，减少临时表

#### 1.6 数据备份与恢复

**每日备份策略**：
```bash
# 完整备份
mysqldump -uroot -p --databases pharmacy_db > backup_20260103.sql

# 增量备份（使用binlog）
mysqlbinlog --start-datetime="2026-01-03 00:00:00" \
            --stop-datetime="2026-01-03 23:59:59" \
            mysql-bin.000001 > incremental_backup.sql
```

**恢复操作**：
```bash
# 从备份文件恢复
mysql -uroot -p pharmacy_db < backup_20260103.sql
```

#### 1.7 安全管理

**用户权限控制**：
```sql
-- 创建应用用户
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'secure_password';

-- 授予必要权限
GRANT SELECT, INSERT, UPDATE, DELETE ON pharmacy_db.* TO 'app_user'@'localhost';

-- 禁止DROP/TRUNCATE等危险操作
REVOKE DROP ON pharmacy_db.* FROM 'app_user'@'localhost';
```

**数据加密**：
- 密码字段使用MD5/SHA256加密
- 敏感信息（客户病史）访问控制
- SSL连接配置

#### 1.8 监控与维护

**日常监控指标**：
- 数据库连接数：`SHOW PROCESSLIST;`
- 表空间使用率：`SHOW TABLE STATUS;`
- 慢查询统计：`slow_query_log`
- 死锁检测：`SHOW ENGINE INNODB STATUS;`

**定期维护**：
```sql
-- 优化表碎片
OPTIMIZE TABLE t_sales_detail;

-- 分析表统计信息
ANALYZE TABLE t_medicine;

-- 检查表完整性
CHECK TABLE t_stock_batch;
```

#### 1.9 数据字典维护

| 表名 | 中文名 | 说明 |
|------|--------|------|
| t_employee | 员工表 | 系统用户登录账号 |
| t_medicine | 药品信息表 | 药品基础档案 |
| t_stock_batch | 库存批次表 | 按批号管理库存（FEFO） |
| t_sales_order | 销售单主表 | 销售订单头信息 |
| t_sales_detail | 销售明细表 | 销售订单行项目 |
| t_purchase_order | 进货单主表 | 采购订单头 |
| t_purchase_detail | 进货明细表 | 采购订单行项目 |
| t_finance_daily | 财务日结表 | 每日财务汇总 |

#### 1.10 应急响应

**常见问题处理**：
- 主键冲突：检查AUTO_INCREMENT值
- 外键约束错误：检查关联表数据
- 死锁问题：优化事务逻辑，减少锁持有时间
- 表损坏：使用 REPAIR TABLE 修复

**数据恢复流程**：
1. 评估数据丢失范围
2. 停止应用访问
3. 从最近备份恢复
4. 应用增量binlog
5. 验证数据完整性
6. 恢复应用服务

---

## 二、关键设计说明

### 2.1 库存批次管理（FEFO）
- 使用 `t_stock_batch` 表按批号（batch_no）管理库存
- `cur_batch__qty` 字段记录当前批次剩余数量（注意双下划线）
- `create_time` 为DATE类型，记录批次创建日期
- 触发器自动维护库存数量，确保账实一致

### 2.2 单据编号规则
- 进货单：P+日期(yyyyMMdd)+4位流水号，如 P202601030001
- 销售单：S+日期(yyyyMMdd)+4位流水号，如 S202601030001
- 使用存储函数自动生成，避免重复

### 2.3 财务计算逻辑
```sql
-- 净利润计算（计算列）
net_profit = sales_profit        -- 销售毛利
           - sales_return_amt    -- 销售退货
           + purc_return_amt     -- 购进退货
           - inv_loss_amt        -- 盘亏
           + inv_gain_amt        -- 盘盈
```

### 2.4 权限角色设计
- **Admin**：系统管理员，全部权限
- **Sales**：销售员，负责销售、客户管理
- **Stock**：库管员，负责采购、库存、盘点

（已移除Finance角色，财务功能合并到Admin）

---

## 三、运维规范

### 3.1 日常检查清单（每日）
- [ ] 检查数据库连接数是否异常
- [ ] 查看慢查询日志
- [ ] 检查磁盘空间使用率
- [ ] 验证备份任务是否成功
- [ ] 检查错误日志（error.log）

### 3.2 周度维护（每周）
- [ ] 分析表统计信息（ANALYZE TABLE）
- [ ] 清理过期binlog
- [ ] 检查索引使用率
- [ ] 审计用户权限

### 3.3 月度任务
- [ ] 归档历史数据
- [ ] 表碎片整理（OPTIMIZE TABLE）
- [ ] 性能测试与调优
- [ ] 备份策略评审

---

## 四、故障案例与解决方案

### 案例1：库存数据不一致
**现象**：销售后 total_stock 未扣减
**原因**：触发器执行失败
**解决**：
```sql
-- 检查触发器状态
SHOW TRIGGERS LIKE 't_sales_detail';

-- 手工修复数据
UPDATE t_medicine m
SET total_stock = (
    SELECT SUM(cur_batch__qty) FROM t_stock_batch WHERE med_id = m.med_id
);
```

### 案例2：外键约束删除失败
**现象**：删除供应商时报错"Cannot delete or update a parent row"
**原因**：存在关联的采购单
**解决**：
```sql
-- 先删除关联数据
DELETE FROM t_purchase_detail WHERE po_id IN (
    SELECT po_id FROM t_purchase_order WHERE sup_id = 123
);
DELETE FROM t_purchase_order WHERE sup_id = 123;
-- 再删除供应商
DELETE FROM t_supplier WHERE sup_id = 123;
```

### 案例3：慢查询优化
**现象**：销售报表查询超时
**优化**：
```sql
-- 优化前
SELECT m.med_name, SUM(sd.quantity) FROM t_sales_detail sd
JOIN t_medicine m ON sd.med_id = m.med_id;

-- 优化后（使用视图）
SELECT * FROM v_top_selling;
```

---

## 五、技术栈说明
- **数据库**：MySQL 8.0+
- **字符集**：utf8mb4（支持emoji）
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB（支持事务和外键）
- **连接工具**：MySQL Workbench / Navicat
- **备份工具**：mysqldump / Xtrabackup

---

**文档维护人**：数据库管理员  
**最后更新**：2026-01-03  
**版本号**：v1.0
